apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: dev-microservices
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions:
    - missingkey=error

  generators:
  - list:
      elements:
        # -------- corporate-banking --------
        - domain: corporate-banking
          service: compliance-service
          namespace: corporate-banking
        - domain: corporate-banking
          service: corp-banking-api
          namespace: corporate-banking
        - domain: corporate-banking
          service: corp-banking-ui
          namespace: corporate-banking
        - domain: corporate-banking
          service: treasury-service
          namespace: corporate-banking

        # -------- retail-banking --------
        - domain: retail-banking
          service: account-service
          namespace: retail-banking
        - domain: retail-banking
          service: fraud-detection
          namespace: retail-banking
        - domain: retail-banking
          service: logging-service
          namespace: retail-banking
        - domain: retail-banking
          service: retail-banking-api
          namespace: retail-banking
        - domain: retail-banking
          service: retail-banking-ui
          namespace: retail-banking
        - domain: retail-banking
          service: transaction-service
          namespace: retail-banking

        # -------- loans --------
        - domain: loans
          service: credit-scoring
          namespace: loans
        - domain: loans
          service: document-processing
          namespace: loans
        - domain: loans
          service: loans-api
          namespace: loans
        - domain: loans
          service: loans-ui
          namespace: loans

  template:
    metadata:
      name: "dev-{{.service}}"
      labels:
        environment: "dev"
        app: "{{.service}}"
    spec:
      project: banking

      source:
        repoURL: https://github.com/akmadan/gitops-product-demo
        targetRevision: main
        path: "services/{{.domain}}/{{.service}}/overlays/dev"

      destination:
        server: "https://kubernetes.default.svc"
        namespace: "{{.namespace}}"

      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true